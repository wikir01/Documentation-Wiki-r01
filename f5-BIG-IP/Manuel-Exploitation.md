Procédures
==========

Migration de VS d'un cluster de f5 vers un nouveau
--------------------------------------------------

L'objectif de cet article est de détailler comment migrer un VS d'un vieux f5 vers un nouveau f5.

### **Résumé rapide d'une migration de VS d'un f5 à un autre:**

1.  Récupérer toutes les informations de:
    *   Node
    *   Pool
    *   Monitoring des nodes dans le pool
    *   VS
    *   SNAT Pool
    *   Partition
2.  Créer sur nouveau f5 dans la bonne partition:
    *   Node
    *   Pool (ne pas oublier de le rajouter dans le hagroup adapté dans la bonne partition)
    *   VS avec une mauvaise IP
3.  Sur l'ancien f5 (le but c'est de libérer l'ip de SNAT et du VS pour qu'elle soit utilisée sur le nouveau f5 sans conflit ARP)
    *   Changer l'IP du VS en mettant une mauvaise IP
    *   Changer SNAT pour une mauvaise IP
4.  Sur le nouveau f5:
    *   Changer l'IP du VS pour la bonne IP
    *   Changer le SNAT pour la bonne SNAT Pool
5.  Confirmer que l'application fonctionne
6.  Supprimer tout sur l'ancien f5

Procédure de mise à jour
------------------------

Vérifier combien de saut de version il faut faire pour atteindre la cible: https://support.f5.com/csp/article/K13845

Exemple: Nous souhaitons arriver en version 15.1.x or d'après l'article Upgrade Path, il faut faire un saut en 13.x avant d'arriver en 15.x

### Prérequis et préparation

Dans l'ordre, les prérequis sont les suivants:

*   Vous devez avoir accès en tant qu'administrateur aux f5 (en HTTPS ainsi qu'en SSH et TMSH)
*   Vous avez un outil (mobaxterm) pour naviguer dans les fichiers du f5.
*   Vous devez avoir le fichier .iso ainsi que son .iso.md5 pour faire la mise à jour. Tout est disponible directement depuis https://downloads.f5.com/
*   Vérifier que le fichier de mise à jour n'est pas corrompu
*   Créer un backup de la configuration BIG-IP et de la licence
*   (Optionnel mais recommandé) Créer un backup du fichier crontab
*   Réactiver la licence BIG-IP https://support.f5.com/csp/article/K7727
*   (Optionnel mais recommandé) Préparer un PC expert ainsi qu'un câble série si ça se passe mal (sourire)
*   (Optionnel mais recommandé) Redemarrer un membre du cluster, puis l'autre pour vérifier qu'ils pourront redémarrer après la maj.
*   Désactiver la synchro automatique des deux boitiers (sinon ils rebootent en même temps)
*   Vérifier que les certificats systèmes sont toujours valides (sinon la mise à jour ne se font pas)
*   Vérifier que les deux équipements sont bien synchro au niveau de la conf.
*   Désactiver Centreon pour éviter le spammage d'emaim
*   Faire un état des lieux avant et après la migration (status des VS, Pool, Nodes)
*   Demander à toutes les applis de vérifier leur fonctionnement AVANT la migration ainsi qu'APRES la migration. Toute application qui n'a pas testé avant ne sera pas prioritaire pour le débug après la mise à jour.

### Vérifier que le fichier de mise à jour n'est pas corrompu

Ouvrir une invite de commande windows (cmd) et se placer dans le dossier qui contient le .iso ainsi que le .iso.md5

Tapez la commande suivante:

certutil -hashfile <fichier\_image.iso> MD5 & type <fichier\_image.iso.md5>

Par exemple:

certutil -hashfile BIGIP-16.0.0-0.0.12.iso MD5 & type BIGIP-16.0.0-0.0.12.iso.md5

Voici le résultat attendu:

MD5 hash of BIGIP-16.0.0-0.0.12.iso:

e4d36ec57f42ee880d157803e3c2a29a

CertUtil: -hashfile command completed successfully.

e4d36ec57f42ee880d157803e3c2a29a  BIGIP-16.0.0-0.0.12.iso

Le Hash doit correspondre au hash du fichier texte md5.

### Créer un backup de la configuration BIG-IP

Connectez vous sur l'interface de management web du f5

Aller dans System > Archives

Cliquer sur "Create" et spécifiez un nom pour l'archive UCS . Laissez bien Private Keys à Include

Une fois le fichier .ucs généré, téléchargez le.

Il faut aussi télécharger les configurations en cli si jamais l'interface web ne fonctionne pas.

Se connecter en SSH, aller en TMSH et faites tmsh save sys config

Saving running configuration...

 /config/bigip.conf

 /config/bigip\_base.conf

 /config/bigip\_user.conf

Téléchargez également ces fichier .conf.

Il faut aussi backuper le fichier de licence en copiant le fichier /config/bigip.license des deux boitiers.

### (Optionnel mais recommandé) Créer un backup du fichier crontab

En SSH (pas en TMSH) copier le fichier /var/spool/cron/root dans un bloc note.

### Réactiver la licence BIG-IP

La société f5 autorise la mise à jour logicielle de leur boitier uniquement si le boitier a une licence valide.

Une licence "valide" c'est une licence dont la License Activation Date est supérieure à la License Check Date de la version de BIG-IP.

Par exemple:

La License Check Date de BIG-IP 16.0.0 est: June 16, 2020.

Si je veux mettre à jour en version BIG-IP 16.0.0, il faut que ma License Activation Date soit supérieure à June 16, 2020.

Voici le tableau qui regroupe les License Check Date par version de BIG-IP : https://support.f5.com/csp/article/K7727

Pour vérifier la License Check Date du boitier:

grep "Service check date" /config/bigip/license

\> Service check date: 20170424 (/!\\ format AAAAMMJJ)

Dans notre exemple, notre License Check Date est trop ancienne pour être valide sur un BIG-IP 16.0.0. Il va falloir réactiver la licence.

Aller dans System > License > Re-activate (tout en bas de la page).

\[Capture License\]

Sélectionner Activation Method : Manual

Vous verrez les informations suivantes:

Registration Key

Registration Key List

Manual Method : sélectionner Download/Upload File

Step 1: Télécharger le fichier .do

\[Capture Page License f5\]

Allez sur le site d'activation de la licence: https://activate.f5.com/license/dossier.jsp

Envoyez le dossier.

\[Capture Activate f5 Product\]

Acceptez les conditions d'utilisation et Téléchargez la licence

Retour sur le f5 dans System > License et importer le fichier license.txt.

\[Capture import license\]

En cliquant sur NEXT, le boitier va arrêter de rendre le service de loadbalancing le temps qu'il recharge sa configuration. Il faut prévoir une minute.

\[Capture BIG IP qui reboot\]

On peut ensuite vérifier que la Service Check Date s'est actualisée en faisant grep "Service check date" /config/bigip.license

\> Service check date: 20211231

On peut dès à présent continuer la procédure de mise à jour.

### (Optionnel mais recommandé) Redémarrer les deux membres du cluster (l'un après l'autre).

En TMSH, faire un reboot sur le membre passif, puis sur l'autre. On s'assure que les boitiers pourront redémarrer après la mise à jour.

### Désactiver l'Automatic Sync

1.  Se connecter sur l'interface de management.
2.  Aller dans Device Management > Device Groups.
3.  Sélectionner le cluster.
4.  Dans la section Configuration, dans Sync Type, sélectionner Manual with Incremental Sync ou Manual with Full Sync.
5.  Validez en cliquant sur Update.

### Vérifier que les certificats machines sont toujours valides 

Aller dans Sustem > Device Certificate (ou System > Certificate Management > Device Certificate Management > Device Certificate pour les f5 plus récents) et vérifier que le certificat machine est toujours valable.

Sinon il faut le renouveler. 

### Vérifier que les deux équipements sont bien synchro au niveau de la conf.

Vérifier que les équipements sont bien in-sync.

### Mettre à jour un load-balancer: upgrade

Se connecter à l’équipement en SSH avec login/mdp (par défaut, root/ default).

Se placer sur la racine : cd /

Créer le dossier /shared/images si celui-ci n’existe pas déjà

Se connecter à l’aide de WinSCP à l’équipement avec le login et le mot de passe (par défaut, root / default).

Copier le fichier BIGIP-XX.x.x.xxx.x.iso depuis votre bureau vers le dossier /shared/images du BIG-IP. Déposez également le fichier .isoet le .sig dans le dossier /shared/images

Se connecter en SSH avec login et le mot de passe (par défaut, root/default)

Vérifier sur quelle partition on se trouve : switchboot –l   

Ps : On voit ici que l’on se trouve sur la partition HD1.1 (current boot image) avec la version 11.1.0

\[Capture Partitions\]

Retour dans l'interface d'administration, dans System > Software Management > Image List.

\[Capture Image List\]

Cocher la case de l'image que vous souhaitez installer et cliquer sur Install

Selectionner le disque et la partition inutilisée (il proposera que les partitions disponibles) et cliquer sur Install

\[Capture Install Software Image\]

Pour terminer, aller dans le menu "Boot Locations"

Cliquer sur la partition que vous venez d'installer l'image et cliquer sur Activate.

Vous n'êtes pas obligé de mettre "yes" dans Install configuration si aucun changement ont été fait sur le f5 entre temps.

le f5 redémarre immédiatement après avoir cliqué sur OK. Il drop toutes les connexions tant que le système n'a pas redémarré entièrement.

Une fois que la mise à jour est terminée, se connecter à la GUI du boitier à jour et le retirer du force offline (parfois c'est automatique et parfois il faut le faire manuellement).

Passer le membre restant en mode passif puis en forced offline pour que tout le trafic passe sur le boitier à jour. 

Pour terminer, mettez à jour le boitier restant en suivant les étapes précédentes. 

 /!\\ Il arrive que l'interface web ne réponde plus.. pour qu'elle se remette à fonctionner:

   bigstart restart httpd

   bigstart restart tomcat

### Autres astuces

[Autres Astuces](/f5-BIG-IP/f5-BIG-IP-Astuces.md)
